
// ============================================
// ğŸ“„ 6. src/components/faq/FAQCard/FAQCard.tsx
// ============================================

'use client';

import { useState, useEffect } from 'react';
import { ChevronDown, ChevronUp, Eye, ThumbsUp, Sparkles, Edit, Trash2, Save, X } from 'lucide-react';
import { FAQ } from '@/types/faq.types';
import { formatRelativeTime } from '@/lib/utils/format';
import apiClient from '@/lib/api/client';
import { API_ENDPOINTS } from '@/lib/api/endpoints';
import { convertFAQResponseToFAQ } from '@/lib/utils/faq';
import Modal from '@/components/ui/Modal/Modal';
import Button from '@/components/ui/Button/Button';
import Input from '@/components/ui/Input/Input';
import styles from './FAQCard.module.css';

interface FAQCardProps {
  faq: FAQ;
  onUpdate?: (updatedFaq: FAQ) => void;
  onDelete?: (faqId: string) => void;
}

export default function FAQCard({ faq, onUpdate, onDelete }: FAQCardProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  
  // ìˆ˜ì • í¼ ìƒíƒœ
  const [editForm, setEditForm] = useState({
    question: faq.question,
    answer: faq.answer,
    category: faq.category || '',
    tags: Array.isArray(faq.tags) ? faq.tags.join(', ') : (faq.tags || ''),
    status: faq.status,
  });

  // faqê°€ ë³€ê²½ë˜ë©´ í¼ ì—…ë°ì´íŠ¸
  useEffect(() => {
    if (!isEditing) {
      setEditForm({
        question: faq.question,
        answer: faq.answer,
        category: faq.category || '',
        tags: Array.isArray(faq.tags) ? faq.tags.join(', ') : (faq.tags || ''),
        status: faq.status,
      });
    }
  }, [faq, isEditing]);

  // ìˆ˜ì • ëª¨ë“œ ì‹œì‘
  const handleEdit = (e: React.MouseEvent) => {
    e.stopPropagation();
    setIsEditing(true);
    setIsExpanded(true);
  };

  // ìˆ˜ì • ì·¨ì†Œ
  const handleCancelEdit = (e: React.MouseEvent) => {
    e.stopPropagation();
    setEditForm({
      question: faq.question,
      answer: faq.answer,
      category: faq.category || '',
      tags: Array.isArray(faq.tags) ? faq.tags.join(', ') : (faq.tags || ''),
      status: faq.status,
    });
    setIsEditing(false);
  };

  // ìˆ˜ì • ì €ì¥
  const handleSave = async (e: React.MouseEvent) => {
    e.stopPropagation();
    try {
      setIsSaving(true);
      
      const updateData: any = {
        question: editForm.question,
        answer: editForm.answer,
        category: editForm.category || null,
        tags: editForm.tags || null,
        status: editForm.status,
      };

      const response = await apiClient.patch(
        API_ENDPOINTS.FAQ.UPDATE(faq.faqId),
        updateData
      );
      
      const updatedFaq = convertFAQResponseToFAQ(response.data);
      setIsEditing(false);
      
      if (onUpdate) {
        onUpdate(updatedFaq);
      }
    } catch (err: any) {
      console.error('FAQ ìˆ˜ì • ì‹¤íŒ¨:', err);
      alert('FAQ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (err.response?.data?.detail || err.message));
    } finally {
      setIsSaving(false);
    }
  };

  // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ì—´ê¸°
  const handleDeleteClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    setShowDeleteModal(true);
  };

  // ì‚­ì œ í™•ì¸
  const handleConfirmDelete = async () => {
    try {
      setIsDeleting(true);
      await apiClient.delete(API_ENDPOINTS.FAQ.DELETE(faq.faqId));
      setShowDeleteModal(false);
      
      if (onDelete) {
        onDelete(faq.faqId);
      }
    } catch (err: any) {
      console.error('FAQ ì‚­ì œ ì‹¤íŒ¨:', err);
      alert('FAQ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (err.response?.data?.detail || err.message));
      setIsDeleting(false);
    }
  };

  const handleHeaderClick = () => {
    if (!isEditing) {
      setIsExpanded(!isExpanded);
    }
  };

  return (
    <div className={styles.card}>
      <div className={styles.header} onClick={handleHeaderClick}>
        <div className={styles.headerContent}>
          <div className={styles.titleRow}>
            <h3 className={styles.question}>{faq.question}</h3>
            {faq.isAutoGenerated && (
              <span className={styles.aiBadge}>
                <Sparkles size={14} />
                AI
              </span>
            )}
          </div>
          <div className={styles.meta}>
            {faq.category && (
              <span className={styles.category}>{faq.category}</span>
            )}
            {faq.productName && (
              <span className={styles.product}>{faq.productName}</span>
            )}
            <span className={`${styles.status} ${styles[faq.status]}`}>
              {faq.status === 'published' ? 'ê²Œì‹œë¨' : 'ì„ì‹œì €ì¥'}
            </span>
          </div>
        </div>
        <button className={styles.expandButton}>
          {isExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
        </button>
      </div>

      {isExpanded && (
        <div className={styles.body} onClick={(e) => e.stopPropagation()}>
          {isEditing ? (
            <div className={styles.editForm}>
              <div className={styles.formGroup}>
                <label className={styles.formLabel}>ì§ˆë¬¸ *</label>
                <Input
                  value={editForm.question}
                  onChange={(e) => setEditForm({ ...editForm, question: e.target.value })}
                  placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”"
                  fullWidth
                />
              </div>

              <div className={styles.formGroup}>
                <label className={styles.formLabel}>ë‹µë³€ *</label>
                <textarea
                  className={styles.textarea}
                  value={editForm.answer}
                  onChange={(e) => setEditForm({ ...editForm, answer: e.target.value })}
                  placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”"
                  rows={6}
                />
              </div>

              <div className={styles.formGroup}>
                <label className={styles.formLabel}>ì¹´í…Œê³ ë¦¬</label>
                <Input
                  value={editForm.category}
                  onChange={(e) => setEditForm({ ...editForm, category: e.target.value })}
                  placeholder="ì¹´í…Œê³ ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                  fullWidth
                />
              </div>

              <div className={styles.formGroup}>
                <label className={styles.formLabel}>íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                <Input
                  value={editForm.tags}
                  onChange={(e) => setEditForm({ ...editForm, tags: e.target.value })}
                  placeholder="íƒœê·¸1, íƒœê·¸2, íƒœê·¸3"
                  fullWidth
                />
              </div>

              <div className={styles.formGroup}>
                <label className={styles.formLabel}>ìƒíƒœ</label>
                <select
                  className={styles.select}
                  value={editForm.status}
                  onChange={(e) => setEditForm({ ...editForm, status: e.target.value as 'draft' | 'published' })}
                >
                  <option value="draft">ì„ì‹œì €ì¥</option>
                  <option value="published">ê²Œì‹œë¨</option>
                </select>
              </div>

              <div className={styles.editActions}>
                <Button
                  variant="secondary"
                  onClick={handleCancelEdit}
                  disabled={isSaving}
                >
                  <X size={16} />
                  ì·¨ì†Œ
                </Button>
                <Button
                  variant="primary"
                  onClick={handleSave}
                  loading={isSaving}
                >
                  <Save size={16} />
                  ì €ì¥
                </Button>
              </div>
            </div>
          ) : (
            <>
              <div className={styles.answer}>
                <p>{faq.answer}</p>
              </div>

              {faq.tags && (
                <div className={styles.tags}>
                  {(Array.isArray(faq.tags) ? faq.tags : [faq.tags]).map((tag, index) => (
                    <span key={index} className={styles.tag}>
                      #{tag}
                    </span>
                  ))}
                </div>
              )}

              <div className={styles.stats}>
                <div className={styles.statItem}>
                  <Eye size={16} />
                  <span>{faq.viewCount}</span>
                </div>
                <div className={styles.statItem}>
                  <ThumbsUp size={16} />
                  <span>{faq.helpfulCount}</span>
                </div>
                <div className={styles.statItem}>
                  <span className={styles.date}>
                    {formatRelativeTime(faq.updatedAt)}
                  </span>
                </div>
              </div>

              <div className={styles.actions}>
                <button className={styles.actionButton} onClick={handleEdit}>
                  <Edit size={16} />
                  ìˆ˜ì •
                </button>
                <button className={`${styles.actionButton} ${styles.danger}`} onClick={handleDeleteClick}>
                  <Trash2 size={16} />
                  ì‚­ì œ
                </button>
              </div>
            </>
          )}
        </div>
      )}

      {/* ì‚­ì œ í™•ì¸ ëª¨ë‹¬ */}
      <Modal
        isOpen={showDeleteModal}
        onClose={() => !isDeleting && setShowDeleteModal(false)}
        title="FAQ ì‚­ì œ í™•ì¸"
        size="sm"
      >
        <div className={styles.deleteModalContent}>
          <p>ì •ë§ë¡œ ì´ FAQë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
          <p className={styles.deleteWarning}>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
          <div className={styles.deleteModalActions}>
            <Button
              variant="secondary"
              onClick={() => setShowDeleteModal(false)}
              disabled={isDeleting}
            >
              ì•„ë‹ˆì˜¤
            </Button>
            <Button
              variant="danger"
              onClick={handleConfirmDelete}
              loading={isDeleting}
            >
              ì˜ˆ, ì‚­ì œí•©ë‹ˆë‹¤
            </Button>
          </div>
        </div>
      </Modal>
    </div>
  );
}
