# 🐈‍⬛ SeShat - 이미지 식별/추출/분리/저장 프로세스
### 작성자 : ScatterRaven
### Tag : 백엔드 서폿, 이미지 처리, RAG, pdf2image, json,
---
## 🔖 작업 내용
**2025.10.20 ~ 2025.10.24**
|항목|결과|항목|비고|
|-|-|-|-|
|이미지 OCR : PaddleOCR|작업 취소|이미지 내 텍스트 추출|정규화 필요|
|이미지 OCR : PaddleOCR|작업 취소|이미지 내 텍스트 정규화|그룹화를 위해 좌표 정규화 필요|
|이미지 OCR : PaddleOCR|작업 취소|이미지 내 좌표 정규화|완료|
|이미지 처리|완료|pdf 내 페이지 변환|-|
|이미지 처리|완료|메타데이터(페이지) 규격화|변경 가능성 존재|
|이미지 처리|완료|페이지 저장|이미지 병합본 처리 후 진행 재개|
|이미지 처리|완료|병합된 페이지 분할|규격 범위 설정 필요|
|이미지 처리|보류|페이지 내 요소 색인/추출|⚠️작업 순위 변경 / 레이아웃 파싱에 문제 발생|
|이미지 처리|보류|메타데이터(요소) 규격화|⚠️작업 순위 변경 / 변경 가능성 존재|
|이미지 처리|보류|요소 저장|⚠️작업 순위 변경|
|크래시 대응|완료|규격 외 병합 pdf 처리 실패|최소 규격 제한에 기반, 강제 미분할 적용|
|크래시 대응|완료|특정 pdf 처리 실패|파일명 길이 제한 추가|
|모듈화|완료|pdf 페이지 단위 처리|-|
|모듈화|보류|pdf 요소 단위 처리|⚠️작업 순위 변경|
|프롬프트| |프롬프트 탈취 및 변경| |
|검증| |모델 이미지 처리| |
|검증| |모델 이미지 기반 설명| |
|검증| |모델 이미지 출력| |
---
## 📝 작업 로그
<details>
<summary>2025.10.20 - 2025.10.21</summary>

### 🪶 OCR를 마저 진행하되, 몇가지 기능의 구현 가능성 및 구현 방식을 검토/시범적 구성

- #### 모델이 실제 제품 형태를 이해하고 그에 맞춰 설명할 수 있는가?

  - **사례 예시**
      - 실제 사람간의 QA를 진행할 때, 문의 신청자는 물론, 상담사도 제품(예: 선풍기)의 형태를 이해한 상태로 이 제품은 이렇게 사용해야 한다~ 라고 설명할 수 있다.
  - **답변 예시**
      - 정면을 바라보는 것을 기준으로 선풍기 몸체의 우측 하단에 리모컨이 내장되어 있습니다
  - **결론**
      - 모델이 실제로 그 형태를 이해하는 것은 기술적으로 어렵다. 대신 그와 비슷하게 흉내내는 것을 기준점으로 잡아야 한다.

- #### 모델이 이미지 출력을 할 수 있는가?
  - 사용자가 설명서를 보여달라고 할 경우 이를 실제로 보여줄 수 있는지를 검토해야 한다.
  - **이미지 '생성'이 아니다**. 데이터베이스 내에 저장된 이미지에서 통째로 출력하건, 일부만 잘라서 가져오건 간에 **'이미 존재하는 이미지'를 불러와 보여주는 것**이 가능한지 여부를 판독하는 것이 핵심이 될 것이다.

</details>

<details>
<summary>2025.10.22 - 2025.10.24</summary>

### 🪶 PDF 내 페이지를 체계적으로 추출/분리/저장하는 모듈 구축

#### 1. PDF 페이지 -> 이미지 변환 설계
- poppler(pdf2image) 활용하여 변환
- dpi는 최소 300, 최대 600을 넘지 않도록 규정
- 최적 DPI 추정 : 400

#### 2. PDF 이미지 저장 모듈 설계
- 이미지는 png, 메타데이터는 json으로 저장
- 메타데이터 구성은 문서 최하단의 포맷 예시와 동일
- (검토 필요) 챗봇이 출력하는 이미지는 webp로 별도 저장하여 활용

#### 3. 변형 : 병합된 이미지 분리 모듈 설계
- 분리 과정 자동화를 위해 처리 로직 설계 필요
- 10개 이상의 변환 이미지 사이즈를 기록해 규격과 허용 가능한 편차 산출, 이후 기준으로 설정
- **일부 PDF의 비정상 규격으로 인한 데이터 소실 문제 관측**, 패딩을 적용하여 규격화
- 탐지 실패 시 육안 확인 후 원인 규정, 수동으로 규격 계산 및 기준 업데이트
- 결과 출력 후 저장 모듈에 반영할 수 있도록 설계 필요

</details>

<details>
<summary>2025.10.27 - 2025.10.28</summary>

### 🪶 PDF 해석 실패 오류 대응

#### 저장 모듈 개선
- 불필요한 정보가 많다고 판단되어 각 정보의 중요도 재평가 실시
- meta.page.json 양식 업데이트

#### 1. 에러 : 규격 외 병합 pdf 처리 실패
- 특정 pdf가 A시리즈 규격을 따르지 않음
- 기준에 기반하여 최소 이미지 사이즈에 제한을 두고, 예외 처리를 진행하여 분할 미적용 처리
- 해당 안전장치를 기존 함수에 내장

#### 2. 에러 : 특정 pdf 처리 실패
- 특정 pdf를 불러오는데 실패하는 현상 관측
- 확인 결과 : 과도하게 긴 파일명으로 인식 제한에 걸린 것으로 파악
- GPT 확인 결과 : 파일명을 변조하여 짧게 축약된 버전으로 복사한 뒤 처리하는 방법을 제안
- 검토 결과 : 변형된 pdf 생성하는 것은 여러 pdf를 처리해야 하는 상황에서 문제가 될 가능성 다소 존재
- 예외 처리를 적용하여 파일 인식에 실패한 경우 해당 pdf의 처리를 생략하고 경고 출력
- 해당 안전장치를 기존 함수에 내장

</details>

<details>
<summary>2025.11.03 - 2025.11.07</summary>

### 🪶 모듈화 / 프롬프트 엔지니어링 진행

#### 1. PDF 페이지 변환 모듈 설계
- 기존 .ipynb 테스트 코드 활용, 통합된 모듈 생성
- 무작위 pdf가 아닌 사용자가 직접 절대경로를 입력하도록 변경
- 페이지 변환 모듈 포함
- 페이지 자동 분열 포함
- 저장 모듈 포함
- (미확정) 원본 데이터 저장 폴더 추가

#### 2. 에러 : 파일 경로 탐색 실패
- 모듈 내 pdf 파일 호출 실패 현상 관측
- 확인 결과 : ipynb -> py로 코드를 변경하는 과정에서 환경에 따른 경로 차이 미반영
- 검토 : 다른 환경에서도 동작할 수 있도록 경로 탐색 부분을 보완
- 실행 파일을 기반으로 경로 추적하여 절대경로 확보

#### 3. 작업 계획 변경
- 이미지 요소 추출 작업에서 다양한 에러가 발생
  - LayoutParser 실행 실패 및 설치 실패, 이미지 추출 실패
- 처리 항목에 프롬프트 엔지니어링 추가
- 판단 : 작업 속도 부진, 우선순위 재설정 필요
  - 요소 추출 중단 및 프롬프트 엔지니어링을 1순위로 진행

</details>

---

## 디렉토리 구조

```
PandDF_ManuAITalk/
    ├ artifacts/ <-- main.py에 의해 자동 생성, 이미지 변환 결과 저장
        ├ 3a5b3c37-a98f-5f46-a15a-4b822348c8f9
        ├ 9d172a76-d221-571b-a1f1-de96d5d993cd
        └ ...
    └ ex_data/ <-- gitignore 제외 대상, 예제 데이터
    ├ modules/
        └ converter/
            └ pdf_converter.py
    ├ .env
    ├ .gitignore
    ├ main.py
    ├ README.md
    └ requirements.txt
```

---

## 🧾 포맷 예시

### ❓ (미확정) elements.json
```json
[
  {
    "doc_id": "12c1bd20-da56-4e72-8362-29ac2a66bace",
    "page_id": "12c1bd20-da56-4e72-8362-29ac2a66bace_p5",
    "element_id": "12c1bd20-da56-4e72-8362-29ac2a66bace_p5_tb-2-3",
    "origin_page": 5,
    "page": 5,
    "type": "table",
    "bbox": [120, 300, 480, 500],
    "caption": "표 2-3. 주요 스펙 비교",
    "ref_id": "tb-2-3"
  },
  {
    "doc_id": "12c1bd20-da56-4e72-8362-29ac2a66bace",
    "page_id": "12c1bd20-da56-4e72-8362-29ac2a66bace_p7",
    "element_id": "12c1bd20-da56-4e72-8362-29ac2a66bace_p7_tb-2-3",
    "origin_page": 7,
    "page": 7,
    "type": "figure",
    "bbox": [100, 200, 500, 650],
    "caption": "그림 3-1. 배선도",
    "ref_id": "fig-3-1"
  }
]
```
### 📌 meta.page.json
```json
[
  {
    "doc_id": "0003040d-0f71-4729-bd3b-733f3c8962bf",
    "page": 1,
    "slice_index": 0,
    "language":"ko",
    "source": "../ex_data/TEST-ALPHA01.pdf",
    "image": "../artifacts/0003040d-0f71-4729-bd3b-733f3c8962bf/TEST-ALPHA01_ko_p1_0.png",
    "modified_at": "2024-09-06T01:57:29Z"
  },
  {
    "doc_id": "0003040d-0f71-4729-bd3b-733f3c8962bf",
    "page": 2,
    "slice_index": 0,
    "language":"ko",
    "source": "../ex_data/TEST-ALPHA01.pdf",
    "image": "../artifacts/0003040d-0f71-4729-bd3b-733f3c8962bf/TEST-ALPHA01_ko_p2_0.png",
    "modified_at": "2024-09-06T01:57:29Z"
  },
  {
    "doc_id": "0003040d-0f71-4729-bd3b-733f3c8962bf",
    "page": 2,
    "slice_index": 1,
    "language":"ko",
    "source": "../ex_data/TEST-ALPHA01.pdf",
    "image": "../artifacts/0003040d-0f71-4729-bd3b-733f3c8962bf/TEST-ALPHA01_ko_p2_1.png",
    "modified_at": "2024-09-06T01:57:29Z"
  }
]
```